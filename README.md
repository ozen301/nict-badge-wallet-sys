# NICT Badge & Wallet System

This repository implements the **Badge & Wallet System** for the NICT project carried out by Tohoku University. It manages NFT-based badges, bingo cards, and blockchain transactions.

## Project Structure

```
nict-badge-wallet-sys/
├─ nictbw/
│  ├─ blockchain/       # Blockchain API interaction
│  ├─ db/               # DB engine, session, metadata, utilities
│  ├─ models/           # SQLAlchemy ORM 2.0 models
├─ scripts/             # utility scripts
├─ tests/               # unit tests
├─ .env.example         # environment variables example
├─ code_examples.ipynb  # Jupyter notebook with code examples
├─ README.md
└─ pyproject.toml
```

---

## Quick Start

### Prerequisites
- Python >= 3.11

### 1. Install the library (in editable mode)
```bash
pip install -e .
```

### 2. Configure .env file
Copy `.env.example` to `.env` and modify as needed.

### 3. Initialize the database
```bash
python scripts/init_db.py
python scripts/seed_dev.py  # optional, seed dev data
```

This by default creates `dev.db` (SQLite) with all schema objects. The `init_db.py` script will print all created tables:

```
Created tables: admins, audit_logs, bingo_cards, bingo_cells, blockchain_transactions, nft_conditions, nft_templates, nfts, user_nft_ownership, users
```
---

## Switch Databases
Simply change the `DB_URL` variable in `.env`:

```python
DB_URL="sqlite:///./dev.db"  # SQLite by default
```

Any URL supported by SQLAlchemy is valid here.

---

## Code Examples

See the Jupyter notebook [`code_examples.ipynb`](code_examples.ipynb) for code snippets:

- Setting up the engine and models
- Basic CRUD with SQLAlchemy 2.0
- Using `ChainClient` to get balance/NFTs and mint an NFT

Before running the notebook, ensure your `.env` is configured (copy from `.env.example`).

---

## Run Tests (for Development)
The repository includes unit tests (generated by Codex) under `tests/` using Python's built-in `unittest`.

Run all tests:
```bash
cd tests
python -m unittest -v
```

Run specific tests/files:
```bash
cd tests
python -m unittest -v test_db_utils test_models
```

---

## TODO
* Add a unique "name" field to the `NFTCondition` model.
* Add bingo cell unlocking logic to `issue_badge_to_user` function.
* Add bingo card generator that randomizes NFT Template assignments to cells.
* Implement `NFTCondition`'s `location_range` and `othe rconditions` verification logic.
* Update `BlockchainTransaction` model to include recipient paymail instead of user_id.
* Include NFT metadata in blockchain related operations. (Currently not implemented due to API bugs.)
* Update `sync_nfts_from_chain` method in `user.py` to handle NFTs that are on chain but not in DB.
* Improve error handling for request-related functions.
* Add Alembic.
* Implement audit logging.
---
